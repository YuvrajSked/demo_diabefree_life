#!/usr/bin/env bash
# Exit on error
set -o errexit

# Install Ruby dependencies
echo "Installing Ruby dependencies..."
bundle config path 'vendor/bundle'
bundle install --jobs 4

# Install and build Next.js frontend
echo "Building Next.js frontend..."
cd frontend
yarn install
# Disable Turbopack and use standard build
export TURBOPACK=0
yarn build
cd ..

# Setup database and run migrations
echo "Setting up database..."
bin/rails db:create
bin/rails db:migrate

# Only run seed data if this is a web instance in the Render environment
if [ "$RENDER" = "true" ] && [ "$RENDER_INSTANCE_TYPE" = "web" ]; then
  echo "Running database seed..."
  bin/rails db:seed
fi

# Precompile Rails assets
echo "Precompiling Rails assets..."
NODE_ENV=production bundle exec rails assets:precompile
